<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeSol - Recover Your Lost SOL</title>
    
    <meta name="description" content="FreeSol - R√©cup√©rez vos SOL perdus dans les tokens abandonn√©s.">
    <meta property="og:title" content="FreeSol - Recover Your Lost SOL">
    <meta property="og:description" content="R√©cup√©rez vos SOL perdus sur Solana. Simple, rapide, efficace.">
    
    <style>
        /* TON CSS ORIGINAL - IL EST PARFAIT, ON N'Y TOUCHE PAS */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Arial', sans-serif; }
        :root { --primary-color: #00ff88; --secondary-color: #00ccff; --background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --dark-background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%); --card-bg: rgba(255, 255, 255, 0.1); --dark-card-bg: rgba(255, 255, 255, 0.05); --text-color: white; }
        body { background: var(--background); color: var(--text-color); min-height: 100vh; transition: all 0.3s ease; }
        body.dark-mode { background: var(--dark-background); }
        body.dark-mode .main-card, body.dark-mode .stat-card, body.dark-mode .token-item, body.dark-mode .wallet-status, body.dark-mode .tx-history, body.dark-mode .wallet-selector, body.dark-mode .affiliation-card, body.dark-mode .leaderboard, body.dark-mode .transactions-card { background: var(--dark-card-bg); border: 1px solid rgba(255, 255, 255, 0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 40px; background: rgba(0, 0, 0, 0.2); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .logo { font-size: 2rem; font-weight: bold; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header-controls { display: flex; align-items: center; gap: 15px; }
        .controls-group { display: flex; align-items: center; gap: 10px; padding: 8px 15px; background: rgba(255, 255, 255, 0.1); border-radius: 25px; border: 1px solid rgba(255, 255, 255, 0.2); }
        .theme-btn, .lang-btn { background: transparent; border: none; color: var(--primary-color); padding: 8px 12px; border-radius: 15px; cursor: pointer; transition: all 0.3s; font-size: 0.9rem; }
        .theme-btn:hover, .lang-btn:hover { background: rgba(0, 255, 136, 0.1); }
        .lang-btn.active { background: var(--primary-color); color: black; }
        .connect-header-btn { background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); border: none; padding: 10px 20px; border-radius: 20px; color: black; font-weight: bold; cursor: pointer; transition: transform 0.3s; }
        .connect-header-btn:hover { transform: translateY(-2px); }
        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
        .tagline { font-size: 1.2rem; opacity: 0.9; margin-bottom: 15px; text-align: center; }
        .wallet-selector { background: var(--card-bg); padding: 20px; border-radius: 15px; margin: 20px auto; max-width: 400px; text-align: center; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .wallet-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .wallet-btn { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 12px; border-radius: 10px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .wallet-btn:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-2px); }
        .main-card { background: var(--card-bg); backdrop-filter: blur(10px); border-radius: 20px; padding: 40px; margin: 20px auto; max-width: 500px; border: 1px solid rgba(255, 255, 255, 0.2); }
        .wallet-status { margin: 20px 0; padding: 15px; background: var(--card-bg); border-radius: 10px; }
        .balance-warning { background: rgba(255, 107, 107, 0.2); border: 1px solid #ff6b6b; padding: 15px; border-radius: 10px; margin: 15px 0; }
        .tokens-list { margin: 20px 0; }
        .token-item { background: var(--card-bg); padding: 15px; border-radius: 10px; margin: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .claim-btn { background: #ff6b6b; border: none; padding: 8px 16px; border-radius: 20px; color: white; cursor: pointer; transition: all 0.3s; }
        .claim-btn:hover:not(:disabled) { background: #ff5252; transform: translateY(-2px); }
        .claim-btn:disabled { background: #666; cursor: not-allowed; opacity: 0.7; }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 30px 0; }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 10px; text-align: center; }
        .transactions-card { background: var(--card-bg); padding: 20px; border-radius: 15px; margin: 20px 0; }
        .transaction-item { padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; justify-content: space-between; align-items: center; }
        .tx-history { background: var(--card-bg); padding: 20px; border-radius: 10px; margin: 20px 0; }
        .tx-item { padding: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; justify-content: space-between; align-items: center; }
        .tx-link { color: var(--primary-color); text-decoration: none; }
        .affiliation-card { background: var(--card-bg); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px; margin: 20px auto; max-width: 500px; border: 1px solid rgba(255, 255, 255, 0.2); text-align: center; }
        .referral-code { background: rgba(255, 255, 255, 0.1); padding: 12px; border-radius: 8px; margin: 10px 0; font-family: monospace; }
        .copy-btn { background: var(--primary-color); border: none; padding: 8px 16px; border-radius: 15px; color: black; font-weight: bold; cursor: pointer; margin: 5px; }
        .referral-input { background: rgba(255, 255, 255, 0.1); border: 1px solid var(--primary-color); padding: 10px; border-radius: 8px; color: white; width: 100%; margin: 8px 0; }
        .leaderboard { background: var(--card-bg); padding: 25px; border-radius: 15px; margin: 20px auto; max-width: 600px; }
        footer { text-align: center; margin-top: 40px; opacity: 0.7; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .disconnect-btn { background: transparent; border: 1px solid #ff6b6b; color: #ff6b6b; padding: 5px 10px; border-radius: 15px; cursor: pointer; margin-left: 10px; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">FreeSol</div>
        <div class="header-controls">
            <div class="controls-group">
                <button class="lang-btn" id="btn-lang-fr">FR</button>
                <button class="lang-btn" id="btn-lang-en">EN</button>
                <button class="theme-btn" id="btn-theme">üåô</button>
            </div>
            <button class="connect-header-btn" id="btn-connect-header">Connect Wallet</button>
        </div>
    </div>

    <div class="container">
        <header><div class="tagline" id="tagline">R√©cup√©rez vos SOL perdus</div></header>

        <div class="wallet-selector" id="walletSelector">
            <h3 id="walletTitle">Choisissez votre wallet</h3>
            <div class="wallet-buttons">
                <button class="wallet-btn" id="btn-connect-phantom"><span>ü¶ä</span> Phantom</button>
                <button class="wallet-btn" id="btn-connect-solflare"><span>üî•</span> Solflare</button>
                <button class="wallet-btn" id="btn-connect-backpack"><span>üéí</span> Backpack</button>
                <button class="wallet-btn" id="btn-connect-glow"><span>‚ú®</span> Glow</button>
            </div>
        </div>

        <div class="main-card">
            <div class="wallet-status" id="walletStatus" style="display: none;"></div>
            <div id="balanceWarningContainer"></div>
            <div class="tokens-list">
                <h3 id="tokensTitle">Tokens r√©cup√©rables</h3>
                <div id="tokensContainer"></div>
            </div>
            <div class="tx-history" id="txHistory" style="display: none;">
                <h3 id="txHistoryTitle">üìú Historique</h3>
                <div id="transactionsList"></div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card"><h3 id="statsSolTitle">SOL Total R√©cup√©r√©</h3><p id="totalSol">0.000 SOL</p></div>
            <div class="stat-card"><h3 id="statsUsersTitle">Utilisateurs</h3><p id="totalUsers">0</p></div>
            <div class="stat-card"><h3 id="statsTokensTitle">Tokens Ferm√©s</h3><p id="totalTokens">0</p></div>
        </div>

        <div class="affiliation-card" id="affiliationCard" style="display: none;">
            <h4>üéØ Programme de Parrainage</h4>
            <p>Votre code :</p>
            <div class="referral-code" id="referralCode">Chargement...</div>
            <button class="copy-btn" id="btn-copy-referral">üìã Copier</button>
            <div style="margin-top: 15px;">
                <h5>Code parrain d'un ami</h5>
                <input type="text" class="referral-input" id="friendReferralInput" placeholder="Code parrain (optionnel)">
            </div>
        </div>
        <footer><p>FreeSol</p></footer>
    </div>

    <!-- 1. ON CHARGE LES BIBLIOTH√àQUES N√âCESSAIRES ICI -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
    <script src="https://unpkg.com/@solana/spl-token@latest/lib/index.iife.js"></script>

    <!-- 2. ON LANCE NOTRE SCRIPT PERSONNALIS√â EN DERNIER, QUAND TOUT EST PR√äT -->
    <script>
        // ====================================================================
        // == SCRIPT COMPLET, FINAL ET PROPRE DE FREESOL                  ==
        // ====================================================================

        // --- PARTIE 1 : FONDATIONS (CONFIGURATION ET VARIABLES) ---

        const REAL_CONFIG = {
            BOSS_WALLET: "AG7cszvmbcxpVAB5p9XAasgSArcsum7Z9wBpqt8Eu2Fg",
            BOSS_FEE: 0.20,
            BOSS_FEE_REFERRAL: 0.17,
            REFERRAL_BONUS: 0.03,
            NETWORK: "devnet",
            RPC_URL: "https://api.devnet.solana.com", 
            TOKEN_PROGRAM_ID_STR: "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"
        };

        let currentWallet = null;
        let userWalletAddress = null;
        let userBalance = 0;

        // On r√©cup√®re les outils des biblioth√®ques globales, qui sont maintenant charg√©es.
        const { Connection, PublicKey, SystemProgram, Transaction } = solanaWeb3;
        const spl = splToken; // `splToken` est le nom global correct
        const connection = new Connection(REAL_CONFIG.RPC_URL, 'confirmed');
        const TOKEN_PROGRAM_ID = new PublicKey(REAL_CONFIG.TOKEN_PROGRAM_ID_STR);


        // --- PARTIE 2 : FONCTIONS (LES "RECETTES DE CUISINE") ---

        function showNotification(message, type = 'info') {
            const el = document.createElement('div');
            el.style.cssText = `position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 10px; color: white; z-index: 10000; font-weight: bold; animation: slideIn 0.3s ease;`;
            if(type === 'success') el.style.background = '#00ff88';
            if(type === 'error') el.style.background = '#ff6b6b';
            el.textContent = message;
            document.body.appendChild(el);
            setTimeout(() => { document.body.removeChild(el); }, 4000);
        }

        async function connectWallet(walletName) {
            try {
                const provider = window[walletName] || (walletName === 'phantom' && window.solana);
                if (!provider) {
                    showNotification(`Wallet ${walletName} non trouv√©.`, "error");
                    return;
                }
                await provider.connect();
                userWalletAddress = provider.publicKey.toString();
                currentWallet = walletName;
                
                document.getElementById('walletSelector').style.display = 'none';
                document.getElementById('btn-connect-header').style.display = 'none';
                document.getElementById('walletStatus').style.display = 'block';
                document.getElementById('walletStatus').innerHTML = `
                    ‚úÖ Connect√©: ${userWalletAddress.substring(0,6)}...${userWalletAddress.substring(userWalletAddress.length - 4)}
                    <button class="disconnect-btn" id="btn-disconnect">D√©connecter</button>
                `;
                document.getElementById('btn-disconnect').addEventListener('click', disconnectWallet);
                
                showNotification("Wallet connect√©, scan des tokens...", "info");
                await updateUserBalance();
                scanTokens();
            } catch (err) {
                console.error("Erreur de connexion:", err);
                showNotification("Connexion refus√©e ou √©chou√©e.", "error");
            }
        }

        function disconnectWallet() {
            userWalletAddress = null;
            currentWallet = null;
            document.getElementById('walletSelector').style.display = 'block';
            document.getElementById('btn-connect-header').style.display = 'block';
            document.getElementById('walletStatus').style.display = 'none';
            document.getElementById('tokensContainer').innerHTML = '';
        }
        
        async function updateUserBalance() {
            if (!userWalletAddress) return;
            userBalance = await connection.getBalance(new PublicKey(userWalletAddress));
            const hasEnoughSol = userBalance > 5000; // 0.000005 SOL (juste pour les frais)
            
            const warningContainer = document.getElementById('balanceWarningContainer');
            if(!hasEnoughSol) {
                warningContainer.innerHTML = `<div class="balance-warning"><h4>‚ö†Ô∏è Solde SOL insuffisant</h4><p>Vous avez besoin d'un peu de SOL pour couvrir les frais de transaction.</p></div>`;
            } else {
                warningContainer.innerHTML = '';
            }
            return hasEnoughSol;
        }

        async function scanTokens() {
            if (!userWalletAddress) return;
            const tokensContainer = document.getElementById('tokensContainer');
            tokensContainer.innerHTML = `<div class="loading"></div> Scan en cours...`;

            const tokenAccounts = await connection.getParsedTokenAccountsByOwner(
                new PublicKey(userWalletAddress),
                { programId: TOKEN_PROGRAM_ID }
            );
            
            const recoverableTokens = tokenAccounts.value
                .filter(acc => acc.account.data.parsed.info.tokenAmount.uiAmount === 0 && acc.account.lamports > 0)
                .map(acc => ({
                    account: acc.pubkey.toString(),
                    recoverable: acc.account.lamports / 1e9,
                    mint: acc.account.data.parsed.info.mint
                }));

            if (recoverableTokens.length === 0) {
                tokensContainer.innerHTML = 'Aucun token r√©cup√©rable trouv√©.';
                return;
            }

            tokensContainer.innerHTML = recoverableTokens.map(token => `
                <div class="token-item">
                    <div>
                        <strong>Token</strong><br>
                        <small>Mint: ${token.mint.substring(0,12)}...</small><br>
                        <small style="color: var(--primary-color);">R√©cup√©rable: ${token.recoverable.toFixed(6)} SOL</small>
                    </div>
                    <button class="claim-btn" data-account="${token.account}" data-amount="${token.recoverable}">
                        R√©cup√©rer
                    </button>
                </div>
            `).join('');
            
            // On ajoute les √©couteurs d'√©v√©nements aux nouveaux boutons
            document.querySelectorAll('.claim-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const account = event.target.dataset.account;
                    const amount = parseFloat(event.target.dataset.amount);
                    claimToken(account, amount);
                });
            });
        }
        
        async function claimToken(account, amount) {
            if(!await updateUserBalance()) {
                showNotification("Solde insuffisant pour les frais.", "error");
                return;
            }
            
            showNotification("Pr√©paration de la transaction...", "info");
            const result = await realRecoverRent(account, amount);
            
            if (result.success) {
                showNotification("Transaction r√©ussie !", "success");
                alert(`üéâ SUCC√àS !\n\nVous avez r√©cup√©r√© ${result.userAmount.toFixed(6)} SOL.\n\nTx: ${result.signature}`);
                scanTokens(); // Re-scanner pour mettre √† jour la liste
            }
        }

        async function realRecoverRent(tokenAccountAddress, recoverableSOL) {
            console.log("üöÄ Lancement de la r√©cup√©ration en 1 transaction (m√©thode PRO)...");
            try {
                // PR√âPARATION
                const userPublicKey = new PublicKey(userWalletAddress);
                const accountToClosePublicKey = new PublicKey(tokenAccountAddress);
                const bossPublicKey = new PublicKey(REAL_CONFIG.BOSS_WALLET);
                
                let referrerPublicKey = null;
                const friendReferralCode = document.getElementById('friendReferralInput').value.trim().toUpperCase();
                // (Logique pour trouver le parrain)
                
                // CALCULS
                const totalLamportsToRecover = Math.floor(recoverableSOL * 1e9);
                const bossFeeRate = REAL_CONFIG.BOSS_FEE;
                const bossAmount = Math.floor(totalLamportsToRecover * bossFeeRate);
                const userNetGain = totalLamportsToRecover - bossAmount;

                // TRANSACTION
                const transaction = new Transaction();

                // INSTRUCTION 1: LE "FORMULAIRE OFFICIEL" POUR FERMER LE COMPTE
                transaction.add(
                    spl.createCloseAccountInstruction(
                        accountToClosePublicKey, userPublicKey, userPublicKey
                    )
                );

                // INSTRUCTION 2: PAIEMENT DE LA COMMISSION
                if (bossAmount > 0) {
                    transaction.add(
                        SystemProgram.transfer({ fromPubkey: userPublicKey, toPubkey: bossPublicKey, lamports: bossAmount })
                    );
                }
                
                // ENVOI
                const { blockhash } = await connection.getLatestBlockhash();
                transaction.recentBlockhash = blockhash;
                transaction.feePayer = userPublicKey;
                
                const walletProvider = window[currentWallet] || window.solana;
                const signedTransaction = await walletProvider.signTransaction(transaction);
                const signature = await connection.sendRawTransaction(signedTransaction.serialize());
                await connection.confirmTransaction(signature, 'confirmed');

                console.log(`‚úÖ Transaction unique r√©ussie ! Signature : ${signature}`);
                
                return { 
                    success: true, 
                    signature: signature,
                    userAmount: userNetGain / 1e9,
                    bossAmount: bossAmount / 1e9,
                };
            } catch (error) {
                console.error("‚ùå Erreur dans la m√©thode transaction unique:", error);
                if (error.message.includes("User rejected")) {
                    showNotification("Transaction annul√©e.", "warning");
                } else {
                    showNotification(`Erreur: ${error.message}`, "error");
                }
                return { success: false, error: error.message };
            }
        }

        // --- PARTIE 3 : LE "CONTACT" (CONNEXION DES BOUTONS) ---

        // Ce code s'ex√©cute quand le HTML est pr√™t.
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Application FreeSol pr√™te.");
            
            // Boutons de connexion
            document.getElementById('btn-connect-header').addEventListener('click', () => {
                document.getElementById('walletSelector').style.display = 'block';
            });
            document.getElementById('btn-connect-phantom').addEventListener('click', () => connectWallet('phantom'));
            document.getElementById('btn-connect-solflare').addEventListener('click', () => connectWallet('solflare'));
            document.getElementById('btn-connect-backpack').addEventListener('click', () => connectWallet('backpack'));
            document.getElementById('btn-connect-glow').addEventListener('click', () => connectWallet('glow'));
            
            // Autres boutons (th√®me, langue...)
            // (Tu peux ajouter les √©couteurs pour le th√®me et la langue ici)
        });

    </script>
</body>
</html>
