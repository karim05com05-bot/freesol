<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <meta name="description" content="FreeSol - R√©cup√©rez vos SOL perdus dans les tokens abandonn√©s. Gardez 80%, parrain 3%, nous prenons 17%/20%." />
  <meta name="keywords" content="solana, sol, crypto, tokens, rent, recovery, freesol" />
  <meta property="og:title" content="FreeSol - Recover Your Lost SOL" />
  <meta property="og:description" content="R√©cup√©rez vos SOL perdus sur Solana. Gardez 80%, parrain 3%, nous prenons 17%/20%." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://freesol.live" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="FreeSol - Recover Lost SOL" />
  <meta name="twitter:description" content="R√©cup√©rez vos SOL perdus sur Solana. Simple, rapide, efficace." />

  <title>FreeSol - Recover Your Lost SOL</title>

  <!-- Solana SDKs -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
  <script src="https://unpkg.com/@solana/spl-token@latest/lib/index.iife.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family: 'Arial', sans-serif; }
    :root {
      --primary-color: #00ff88;
      --secondary-color: #00ccff;
      --background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --dark-background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
      --card-bg: rgba(255, 255, 255, 0.1);
      --dark-card-bg: rgba(255, 255, 255, 0.05);
      --text-color: white;
    }
    body { background: var(--background); color: var(--text-color); min-height:100vh; transition: all .3s ease; }
    body.dark-mode { background: var(--dark-background); }

    body.dark-mode .main-card,
    body.dark-mode .stat-card,
    body.dark-mode .token-item,
    body.dark-mode .wallet-status,
    body.dark-mode .tx-history,
    body.dark-mode .wallet-selector,
    body.dark-mode .affiliation-card,
    body.dark-mode .leaderboard,
    body.dark-mode .transactions-card {
      background: var(--dark-card-bg);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .header { display:flex; justify-content:space-between; align-items:center; padding:20px 40px; background: rgba(0,0,0,.2); backdrop-filter: blur(10px); border-bottom:1px solid rgba(255,255,255,.1); }
    .logo { font-size:2rem; font-weight:bold; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .maunte-badge { background: linear-gradient(45deg, #ff0080, #ff8c00); padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; margin-left: 10px; }

    .header-controls { display:flex; align-items:center; gap:15px; }
    .controls-group { display:flex; align-items:center; gap:10px; padding:8px 15px; background: rgba(255,255,255,.1); border-radius:25px; border:1px solid rgba(255,255,255,.2); }
    .theme-btn, .lang-btn { background: transparent; border:none; color: var(--primary-color); padding: 8px 12px; border-radius: 15px; cursor:pointer; transition: all .3s; font-size:.9rem; }
    .theme-btn:hover, .lang-btn:hover { background: rgba(0,255,136,.1); }
    .lang-btn.active { background: var(--primary-color); color:black; }

    .connect-header-btn { background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); border:none; padding:10px 20px; border-radius: 20px; color:black; font-weight:bold; cursor:pointer; transition: transform .3s; }
    .connect-header-btn:hover { transform: translateY(-2px); }

    .container { max-width: 1200px; margin:0 auto; padding: 40px 20px; }
    .tagline { font-size: 1.2rem; opacity:.9; margin-bottom: 15px; text-align:center; }

    .wallet-selector { background: var(--card-bg); padding:20px; border-radius:15px; margin:20px auto; max-width: 480px; text-align:center; backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,.2); }
    .wallet-buttons { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px; }
    .wallet-btn { background: rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.3); color:white; padding:12px; border-radius:10px; cursor:pointer; transition: all .3s; display:flex; align-items:center; justify-content:center; gap:8px; }
    .wallet-btn:hover { background: rgba(255,255,255,.2); transform: translateY(-2px); }

    .main-card { background: var(--card-bg); backdrop-filter: blur(10px); border-radius:20px; padding:40px; margin:20px auto; max-width: 600px; border:1px solid rgba(255,255,255,.2); transition: all .3s ease; }
    .wallet-section { text-align:center; margin-bottom: 30px; }
    .wallet-status { margin:20px 0; padding:15px; background: var(--card-bg); border-radius:10px; transition: all .3s ease; }
    .disconnect-btn { background: transparent; border: 1px solid #ff6b6b; color:#ff6b6b; padding:5px 10px; border-radius:15px; cursor:pointer; margin-left:10px; font-size:.8rem; }
    .disconnect-btn:hover { background: rgba(255,107,107,.1); }

    .balance-warning { background: rgba(255,107,107,.2); border:1px solid #ff6b6b; padding:15px; border-radius:10px; margin:15px 0; text-align:left; }
    .balance-warning h4 { color:#ff6b6b; margin-bottom:8px; font-size:1rem; }
    .balance-warning ul { margin:8px 0; padding-left: 20px; font-size:.9rem; }
    .balance-warning li { margin: 4px 0; }

    .tokens-list { margin:20px 0; }
    .token-item { background: var(--card-bg); padding: 15px; border-radius: 10px; margin: 10px 0; display:flex; justify-content:space-between; align-items:center; transition: all .3s ease;}
    .claim-btn { background:#ff6b6b; border:none; padding:8px 16px; border-radius: 20px; color:white; cursor:pointer; transition: all .3s; }
    .claim-btn:hover:not(:disabled) { background:#ff5252; transform: translateY(-2px); }
    .claim-btn:disabled { background:#666; cursor:not-allowed; opacity:.7; }

    .stats { display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; margin:30px 0; }
    .stat-card { background: var(--card-bg); padding:20px; border-radius:10px; text-align:center; transition: all .3s ease; }

    .transactions-card { background: var(--card-bg); padding: 20px; border-radius: 15px; margin: 20px 0; border:1px solid rgba(255,255,255,.2); }
    .transaction-item { padding:12px 0; border-bottom:1px solid rgba(255,255,255,.1); display:flex; justify-content:space-between; align-items:center; }
    .transaction-item:last-child { border-bottom:none; }

    .tx-history { background: var(--card-bg); padding:20px; border-radius:10px; margin:20px 0; transition: all .3s ease; }
    .tx-item { padding:10px; border-bottom:1px solid rgba(255,255,255,.1); display:flex; justify-content:space-between; align-items:center; }
    .tx-item:last-child { border-bottom:none; }
    .tx-link { color: var(--primary-color); text-decoration:none; }
    .tx-link:hover { text-decoration: underline; }

    .affiliation-card { background: var(--card-bg); backdrop-filter: blur(10px); border-radius:15px; padding:20px; margin:20px auto; max-width: 600px; border:1px solid rgba(255,255,255,.2); text-align:center; }
    .affiliation-badge { background: linear-gradient(45deg, #ff0080, #ff8c00); padding:4px 12px; border-radius: 15px; font-size:.8rem; margin-bottom:10px; display:inline-block; }
    .referral-code { background: rgba(255,255,255,.1); padding:12px; border-radius:8px; margin:10px 0; font-family: monospace; font-size:1rem; border:1px solid var(--primary-color); }
    .copy-btn { background: var(--primary-color); border:none; padding:8px 16px; border-radius: 15px; color:black; font-weight:bold; cursor:pointer; margin:5px; transition: transform .3s; font-size:.9rem; }
    .copy-btn:hover { transform: translateY(-2px); }
    .referral-input { background: rgba(255,255,255,.1); border:1px solid var(--primary-color); padding:10px; border-radius:8px; color:white; width:100%; margin:8px 0; font-size:.9rem; }

    .leaderboard { background: var(--card-bg); padding:25px; border-radius:15px; margin:20px auto; max-width: 600px; backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,.2); }
    .leaderboard-title { text-align:center; margin-bottom:20px; color: var(--primary-color); font-size:1.3rem; }
    .leader-item { display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid rgba(255,255,255,.1); transition: all .3s ease; }
    .leader-item:hover { background: rgba(255,255,255,.05); }
    .leader-item:last-child { border-bottom:none; }
    .leader-rank { font-weight:bold; background: var(--primary-color); color:black; padding:6px 10px; border-radius:50%; min-width:30px; text-align:center; font-size:.9rem; }
    .leader-address { flex-grow:1; margin:0 12px; font-family: monospace; font-size:.9rem; }
    .leader-stats { text-align:right; }
    .leader-referrals { font-weight:bold; color: var(--primary-color); font-size:.9rem; }
    .leader-earnings { font-size:.8rem; opacity:.8; }

    footer { text-align:center; margin-top:40px; opacity:.7; }

    .loading { display:inline-block; width:20px; height:20px; border:3px solid rgba(255,255,255,.3); border-radius:50%; border-top-color:#fff; animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .backend-status { display:none; }

    @media (max-width: 768px) {
      .header { padding:15px 20px; flex-direction:column; gap:15px; }
      .header-controls { flex-direction:column; gap:10px; }
      .controls-group { order:-1; }
      .wallet-buttons { grid-template-columns: 1fr; }
      .stats { grid-template-columns: 1fr; }
      .leader-item { flex-direction:column; text-align:center; gap:8px; }
      .leader-address { margin:0; }
    }
  </style>
</head>
<body>
  <!-- Backend status (cach√©) -->
  <div class="backend-status backend-online" id="backendStatus" style="display:none;">üü¢ Backend Online</div>

  <div class="header">
    <div class="logo">FreeSol <span class="maunte-badge">3% R√âELS</span></div>
    <div class="header-controls">
      <div class="controls-group">
        <button class="lang-btn active" onclick="changeLanguage('fr')">FR</button>
        <button class="lang-btn" onclick="changeLanguage('en')">EN</button>
        <button class="theme-btn" onclick="toggleDarkMode()" id="themeToggle" title="Mode Sombre/Clair">üåô</button>
      </div>
      <button class="connect-header-btn" onclick="showWalletSelector()" id="connectHeaderBtn">Connect Wallet</button>
    </div>
  </div>

  <div class="container">
    <header>
      <div class="tagline" id="tagline">R√©cup√©rez vos SOL perdus dans les tokens abandonn√©s</div>
    </header>

    <div class="wallet-selector" id="walletSelector">
      <h3 id="walletTitle">Choisissez votre wallet</h3>
      <div class="wallet-buttons">
        <button class="wallet-btn" data-wallet="phantom" onclick="connectWallet('phantom')"><span>ü¶ä</span> Phantom</button>
        <button class="wallet-btn" data-wallet="solflare" onclick="connectWallet('solflare')"><span>üî•</span> Solflare</button>
        <button class="wallet-btn" data-wallet="backpack" onclick="connectWallet('backpack')"><span>üéí</span> Backpack</button>
        <button class="wallet-btn" data-wallet="glow" onclick="connectWallet('glow')"><span>‚ú®</span> Glow</button>
      </div>
    </div>

    <div class="main-card">
      <div class="wallet-section">
        <div class="wallet-status" id="walletStatus" style="display:none;">
          <div id="walletInfo"></div>
        </div>
      </div>

      <div id="balanceWarningContainer"></div>

      <div class="tokens-list">
        <h3 id="tokensTitle">Tokens r√©cup√©rables</h3>
        <div id="tokensContainer"></div>
      </div>

      <div class="tx-history" id="txHistory" style="display:none;">
        <h3 id="txHistoryTitle">üìú Historique de tes transactions</h3>
        <div id="transactionsList"></div>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card">
        <h3 id="statsSol">SOL r√©cup√©r√©s</h3>
        <p id="totalSol">0.000 SOL</p>
      </div>
      <div class="stat-card">
        <h3 id="statsUsers">Utilisateurs</h3>
        <p id="totalUsers">0</p>
      </div>
      <div class="stat-card">
        <h3 id="statsTokens">Tokens ferm√©s</h3>
        <p id="totalTokens">0</p>
      </div>
    </div>

    <div class="transactions-card">
      <h3>üìú Transactions R√©centes</h3>
      <div id="globalTransactionsList">
        <div style="text-align:center; padding: 20px;">
          <span class="loading"></span>
          <div style="margin-top:10px;">Chargement des transactions...</div>
        </div>
      </div>
    </div>

    <div class="affiliation-card" id="affiliationCard" style="display:none;">
      <div class="affiliation-badge">üéØ PROGRAMME DE PARRAINAGE</div>
      <h4 id="affiliationTitle">Gagnez 3% R√âELS sur vos filleuls !</h4>

      <div class="referral-code" id="referralCode">Chargement...</div>
      <button class="copy-btn" onclick="copyReferralCode()" id="copyBtn">üìã Copier</button>

      <div style="margin: 15px 0; padding: 12px; background: rgba(0, 255, 136, 0.1); border-radius: 8px; font-size: 0.9rem;">
        <p>üë• <strong>Filleuls:</strong> <span id="referralCount">0</span></p>
        <p>üí∞ <strong>Gains R√âELS:</strong> <span id="referralEarnings">0.000 SOL</span></p>
      </div>

      <div style="margin-top: 15px;">
        <h5>üëã Code parrain d'un ami</h5>
        <input type="text" class="referral-input" id="friendReferralInput" placeholder="Code parrain (optionnel)">
        <button class="copy-btn" onclick="applyReferralCode()" id="applyReferral">‚úÖ Appliquer</button>
      </div>
    </div>

    <div class="leaderboard">
      <h3 class="leaderboard-title" id="leaderboardTitle">üèÜ Classement des Top Parrains</h3>
      <div id="leaderboardList">
        <div style="text-align:center; padding: 20px;">
          <span class="loading"></span>
          <div>Chargement du classement...</div>
        </div>
      </div>
    </div>

    <footer>
      <p>
        <span id="footerText">FreeSol - 3% Parrain R√âELS</span>
        <a href="comment-ca-marche.html" style="color: var(--primary-color); margin-left: 20px; text-decoration: none;" id="howItWorksLink">Comment √ßa marche ?</a>
      </p>
    </footer>
  </div>

  <script>
    // ============================== BACKEND SERVICE ==============================
    const BACKEND_CONFIG = {
      BASE_URL: 'https://freesol.onrender.com/api',
      ENDPOINTS: {
        SCAN_TOKENS: '/tokens/scan',
        VERIFY_TX: '/transactions/verify',
        GLOBAL_TRANSACTIONS: '/transactions/global',
        ADD_TRANSACTION: '/transactions/add',
        GLOBAL_STATS: '/global-stats'
      }
    };

    class BackendService {
      async request(endpoint, options = {}) {
        const url = `${BACKEND_CONFIG.BASE_URL}${endpoint}`;
        const config = {
          headers: {
            'Content-Type': 'application/json',
            'Wallet-Address': window.userWalletAddress || '',
            ...options.headers
          },
          ...options
        };
        const res = await fetch(url, config);
        return res.json();
      }
      async scanTokens() {
        return this.request(BACKEND_CONFIG.ENDPOINTS.SCAN_TOKENS, { method: 'POST' });
      }
      async verifyTransaction(signature, expectedBossAmountSOL, tokenAccount) {
        return this.request(BACKEND_CONFIG.ENDPOINTS.VERIFY_TX, {
          method: 'POST',
          body: JSON.stringify({ signature, expectedAmount: expectedBossAmountSOL, tokenAccount })
        });
      }
      async getGlobalTransactions() {
        return this.request(BACKEND_CONFIG.ENDPOINTS.GLOBAL_TRANSACTIONS);
      }
      async addGlobalTransaction(txData) {
        return this.request(BACKEND_CONFIG.ENDPOINTS.ADD_TRANSACTION, {
          method: 'POST',
          body: JSON.stringify(txData)
        });
      }
      async getGlobalStats() {
        return this.request(BACKEND_CONFIG.ENDPOINTS.GLOBAL_STATS);
      }
      async healthCheck() {
        try {
          const res = await fetch('https://freesol.onrender.com/health');
          const data = await res.json();
          return data.status === 'OK';
        } catch (e) {
          return false;
        }
      }
    }

    window.backendService = new BackendService();

    // ============================== NOTIFICATIONS ==============================
    let currentNotification = null;

    function showNotification(message, type = 'info') {
      if (currentNotification) currentNotification.remove();
      const n = document.createElement('div');
      n.style.cssText = `
        position: fixed; top:20px; right:20px; padding:15px 20px; border-radius:10px; color:white; z-index:10000; max-width:420px; font-weight:bold;
        animation: slideIn .3s ease; ${type === 'success' ? 'background:#00ff88; color:black;' : ''}${type==='error'?'background:#ff6b6b;':''}${type==='warning'?'background:#ffa500;':''}${type==='info'?'background:#00ccff;':''}
      `;
      n.textContent = message;
      document.body.appendChild(n);
      currentNotification = n;
      setTimeout(() => {
        if (n.parentNode) {
          n.style.animation = 'slideOut .3s ease';
          setTimeout(()=> { if(n.parentNode) n.parentNode.removeChild(n); currentNotification = null; }, 300);
        }
      }, 4000);
    }
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn { from { transform: translateX(100%); opacity:0; } to { transform: translateX(0); opacity:1; } }
      @keyframes slideOut { from { transform: translateX(0); opacity:1; } to { transform: translateX(100%); opacity:0; } }
    `;
    document.head.appendChild(style);

    // ============================== CONFIG R√âELLE ==============================
    const REAL_CONFIG = {
      BOSS_WALLET: "AG7cszvmbcxpVAB5p9XAasgSArcsum7Z9wBpqt8Eu2Fg",
      BOSS_FEE: 0.20,
      BOSS_FEE_REFERRAL: 0.17,
      USER_SHARE: 0.80, // pour info
      REFERRAL_BONUS: 0.03,
      NETWORK: "devnet",  
      RPC_URL: "https://api.devnet.solana.com"
      TOKEN_PROGRAM_ID: "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"
    };

    const connection = new solanaWeb3.Connection(REAL_CONFIG.RPC_URL, 'confirmed');
    const TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey(REAL_CONFIG.TOKEN_PROGRAM_ID);
    const splToken = window.splToken;

    // ============================== TRADUCTIONS ==============================
    const translations = {
      fr: {
        tagline: "R√©cup√©rez vos SOL perdus dans les tokens abandonn√©s",
        walletTitle: "Choisissez votre wallet",
        connectHeaderBtn: "Connecter Wallet",
        tokensTitle: "Tokens r√©cup√©rables",
        txHistoryTitle: "üìú Historique de tes transactions",
        statsSol: "SOL r√©cup√©r√©s",
        statsUsers: "Utilisateurs",
        statsTokens: "Tokens ferm√©s",
        footerText: "FreeSol - 3% Parrain R√âELS",
        howItWorksLink: "Comment √ßa marche ?",
        affiliationTitle: "Gagnez 3% R√âELS sur vos filleuls !",
        leaderboardTitle: "üèÜ Classement des Top Parrains",
        themeBtnDark: "üåô",
        themeBtnLight: "‚òÄÔ∏è",
        noTokens: "Aucun token r√©cup√©rable trouv√©",
        scanning: "Scan R√âEL en cours...",
        connectError: "Erreur de connexion",
        claimSuccess: "üéâ SUCC√àS!",
        viewTransaction: "üîó Voir",
        noTransactions: "Aucune transaction encore",
        connected: "Connect√©",
        disconnect: "D√©connecter",
        chooseWallet: "Choisir un wallet",
        copyBtn: "üìã Copier",
        applyReferral: "‚úÖ Appliquer",
        balanceWarningTitle: "‚ö†Ô∏è Solde SOL insuffisant",
        balanceWarningText: "Votre wallet doit contenir au moins <strong>0.002 SOL</strong> pour couvrir les frais r√©seau Solana.",
        balanceWarningSolution1: "Achetez du SOL sur un exchange (Binance, Coinbase, etc.)",
        balanceWarningSolution2: "Utilisez un faucet Solana pour tester",
        balanceWarningSolution3: "Demandez √† un ami de vous envoyer 0.01 SOL",
        claimButton: "R√©cup√©rer",
        claimDisabled: "‚ö†Ô∏è Solde insuffisant"
      },
      en: {
        tagline: "Recover your lost SOL from abandoned tokens",
        walletTitle: "Choose your wallet",
        connectHeaderBtn: "Connect Wallet",
        tokensTitle: "Recoverable tokens",
        txHistoryTitle: "üìú Your Transaction History",
        statsSol: "SOL Recovered",
        statsUsers: "Users",
        statsTokens: "Tokens Closed",
        footerText: "FreeSol - 3% Referral REAL",
        howItWorksLink: "How it works?",
        affiliationTitle: "Earn 3% REAL on your referrals!",
        leaderboardTitle: "üèÜ Top Referrers Ranking",
        themeBtnDark: "üåô",
        themeBtnLight: "‚òÄÔ∏è",
        noTokens: "No recoverable tokens found",
        scanning: "REAL scan in progress...",
        connectError: "Connection error",
        claimSuccess: "üéâ SUCCESS!",
        viewTransaction: "üîó View",
        noTransactions: "No transactions yet",
        connected: "Connected",
        disconnect: "Disconnect",
        chooseWallet: "Choose wallet",
        copyBtn: "üìã Copy",
        applyReferral: "‚úÖ Apply",
        balanceWarningTitle: "‚ö†Ô∏è Insufficient SOL Balance",
        balanceWarningText: "Your wallet needs at least <strong>0.002 SOL</strong> to cover Solana network fees.",
        balanceWarningSolution1: "Buy SOL on an exchange (Binance, Coinbase, etc.)",
        balanceWarningSolution2: "Use a Solana faucet for testing",
        balanceWarningSolution3: "Ask a friend to send you 0.01 SOL",
        claimButton: "Recover",
        claimDisabled: "‚ö†Ô∏è Insufficient balance"
      }
    };

    // ============================== √âTAT GLOBAL ==============================
    let currentLanguage = 'fr';
    let currentWallet = null;
    let currentProvider = null;
    let userWalletAddress = null;
    let userReferralCode = null;
    let userBalance = 0;
    let backendOnline = false;

    window.userWalletAddress = null; // pour headers backend

    // ============================== PROVIDERS & TX ==============================
    function getProviderByType(walletType) {
      switch (walletType) {
        case 'phantom':   return window.solana;
        case 'solflare':  return window.solflare;
        case 'backpack':  return window.backpack?.solana || window.backpack;
        case 'glow':      return window.glow?.solana || window.glow;
        default:          return window.solana;
      }
    }

    async function sendAndConfirmTxn(transaction) {
      const { blockhash, lastValidBlockHeight } = await connection.getLatestBlockhash('finalized');
      transaction.recentBlockhash = blockhash;
      transaction.feePayer = new solanaWeb3.PublicKey(userWalletAddress);

      let signature;
      if (currentProvider?.signAndSendTransaction) {
        const res = await currentProvider.signAndSendTransaction(transaction);
        signature = typeof res === 'string' ? res : res.signature;
      } else if (currentProvider?.signTransaction) {
        const signed = await currentProvider.signTransaction(transaction);
        const raw = signed.serialize();
        signature = await connection.sendRawTransaction(raw, { skipPreflight: false });
      } else {
        throw new Error('Wallet provider ne supporte pas la signature de transaction');
      }

      await connection.confirmTransaction({ signature, blockhash, lastValidBlockHeight }, 'confirmed');
      return signature;
    }

    // ============================== OUTILS ==============================
    function isMobile() {
      return /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    }

    const walletDetectors = {
      phantom: () => !!window.solana?.isPhantom || (!!window.solana && isMobile()),
      solflare: () => !!window.solflare?.isSolflare || (!!window.solflare && isMobile()),
      backpack: () => !!(window.backpack?.solana || window.backpack),
      glow: () => !!(window.glow?.solana || window.glow)
    };

    async function checkBackendStatus() {
      try {
        backendOnline = await backendService.healthCheck();
        const statusElement = document.getElementById('backendStatus');
        if (backendOnline) {
          statusElement.textContent = "üü¢ Backend Online";
          statusElement.className = "backend-status backend-online";
        } else {
          statusElement.textContent = "üî¥ Backend Offline";
          statusElement.className = "backend-status backend-offline";
        }
      } catch {
        backendOnline = false;
      }
    }

    // ============================== SOLDE ==============================
    async function getCurrentBalance() {
      if (!userWalletAddress) return 0;
      try {
        const pk = new solanaWeb3.PublicKey(userWalletAddress);
        const lamports = await connection.getBalance(pk, 'confirmed');
        return lamports / 1e9;
      } catch {
        return 0;
      }
    }

    function hasMinimumBalance() { return userBalance >= 0.002; }

    function showBalanceWarning() {
      const c = document.getElementById('balanceWarningContainer');
      if (hasMinimumBalance()) { c.innerHTML = ''; return; }
      c.innerHTML = `
        <div class="balance-warning">
          <h4>${translations[currentLanguage].balanceWarningTitle}</h4>
          <p>${translations[currentLanguage].balanceWarningText}</p>
          <p><strong>${currentLanguage === 'fr' ? 'Solutions :' : 'Solutions:'}</strong></p>
          <ul>
            <li>${translations[currentLanguage].balanceWarningSolution1}</li>
            <li>${translations[currentLanguage].balanceWarningSolution2}</li>
            <li>${translations[currentLanguage].balanceWarningSolution3}</li>
          </ul>
        </div>
      `;
    }

    // ============================== AFFILIATION (LOCAL) ==============================
    function generateReferralCode(walletAddress) {
      return "FREESOL_" + walletAddress.substring(0, 8).toUpperCase();
    }
    function getReferralData() {
      return JSON.parse(localStorage.getItem('freesol_referrals') || '{}');
    }
    function saveReferralData(data) {
      localStorage.setItem('freesol_referrals', JSON.stringify(data));
    }
    function getReferrerAddress() {
      const data = getReferralData();
      return data[userWalletAddress]?.referrer || null;
    }
    function updateAffiliationStats() {
      const referralData = getReferralData();
      const userData = referralData[userWalletAddress] || { referrals: [], earnings: 0, code: userReferralCode };
      document.getElementById('referralCount').textContent = (userData.referrals || []).length;
      document.getElementById('referralEarnings').textContent = (userData.earnings || 0).toFixed(6) + ' SOL';
      document.getElementById('referralCode').textContent = userReferralCode || '‚Äî';
    }
    function copyReferralCode() {
      if (!userReferralCode) return;
      navigator.clipboard.writeText(userReferralCode).then(() => {
        const btn = document.getElementById('copyBtn');
        const t = btn.innerHTML;
        btn.innerHTML = '‚úÖ Copi√© !';
        setTimeout(()=> btn.innerHTML = t, 2000);
      });
    }
    function applyReferralCode() {
      const code = document.getElementById('friendReferralInput').value.trim();
      if (!code || !userWalletAddress) return;

      const referralData = getReferralData();
      let referrerAddress = null;
      for (const [address, data] of Object.entries(referralData)) {
        if (data.code === code) { referrerAddress = address; break; }
      }

      if (referrerAddress && referrerAddress !== userWalletAddress) {
        referralData[userWalletAddress] = referralData[userWalletAddress] || { referrals: [], earnings: 0, code: userReferralCode };
        referralData[userWalletAddress].referrer = referrerAddress;

        referralData[referrerAddress] = referralData[referrerAddress] || { referrals: [], earnings: 0, code: generateReferralCode(referrerAddress) };
        if (!referralData[referrerAddress].referrals.includes(userWalletAddress)) {
          referralData[referrerAddress].referrals.push(userWalletAddress);
        }

        saveReferralData(referralData);
        updateAffiliationStats();
        updateLeaderboard();
        showNotification('‚úÖ Code parrain appliqu√© avec succ√®s !', 'success');
      } else {
        showNotification('‚ùå Code parrain invalide', 'error');
      }
    }
    function updateLeaderboard() {
      const referralData = getReferralData();
      const leaderboardList = document.getElementById('leaderboardList');

      const leaders = Object.entries(referralData)
        .map(([address, data]) => ({
          address,
          referrals: (data.referrals || []).length,
          earnings: data.earnings || 0
        }))
        .sort((a,b) => b.referrals - a.referrals || b.earnings - a.earnings)
        .slice(0,10);

      if (leaders.length === 0) {
        leaderboardList.innerHTML = '<div style="text-align:center; opacity:.7;">Aucun parrain encore</div>';
        return;
      }

      leaderboardList.innerHTML = leaders.map((leader, i) => `
        <div class="leader-item">
          <div class="leader-rank">${i+1}</div>
          <div class="leader-address">${leader.address.substring(0,12)}...${leader.address.substring(leader.address.length-6)}</div>
          <div class="leader-stats">
            <div class="leader-referrals">${leader.referrals} ${currentLanguage === 'fr' ? 'filleuls' : 'referrals'}</div>
            <div class="leader-earnings">${leader.earnings.toFixed(6)} SOL R√âELS</div>
          </div>
        </div>
      `).join('');
    }

    // ============================== SCAN TOKENS ==============================
    async function scanTokens() {
      if (!currentWallet) return;
      const tokensContainer = document.getElementById('tokensContainer');

      try {
        showNotification('üîç ' + (currentLanguage==='fr' ? 'Scan direct Solana...' : 'Direct Solana scan...'), 'info');
        tokensContainer.innerHTML = '<div style="text-align:center;"><span class="loading"></span> Connexion √† Solana...</div>';

        const owner = new solanaWeb3.PublicKey(userWalletAddress);
        const resp = await connection.getParsedTokenAccountsByOwner(owner, { programId: TOKEN_PROGRAM_ID }, 'confirmed');

        const recoverable = [];
        for (const { pubkey, account } of resp.value) {
          try {
            const info = account.data.parsed?.info;
            if (!info) continue;
            // strict: amount === "0" uniquement
            if (info.tokenAmount?.amount === "0") {
              // L'utilisateur doit √™tre owner du token account pour pouvoir close
              if (info.owner !== userWalletAddress) continue;

              const lamports = account.lamports || 0;
              if (lamports > 0) {
                recoverable.push({
                  account: pubkey.toString(),
                  recoverableLamports: lamports,
                  recoverable: lamports / 1e9,
                  mint: (info.mint || '').slice(0,8) + '...',
                  type: 'DIRECT_SCAN'
                });
              }
            }
          } catch {}
        }

        if (recoverable.length) {
          showNotification(`üéØ ${recoverable.length} token(s) r√©cup√©rable(s)!`, 'success');
          displayTokens(recoverable);
        } else {
          tokensContainer.innerHTML = `
            <div style="text-align:center; padding:20px;">
              üéâ ${currentLanguage==='fr' ? 'Aucun token abandonn√© trouv√©' : 'No abandoned token found'}<br>
              <small style="color:#00ff88;">${currentLanguage==='fr' ? 'Tokens scann√©s' : 'Tokens scanned'}: ${resp.value.length}</small>
            </div>
          `;
        }
      } catch (e) {
        console.error('Erreur scan:', e);
        showNotification('‚ùå Erreur de scan', 'error');
        tokensContainer.innerHTML = `<div style="text-align:center; color:#ff6b6b;">Erreur: ${e.message}</div>`;
      }
    }

    function displayTokens(tokens) {
      const c = document.getElementById('tokensContainer');
      if (!tokens || tokens.length === 0) {
        c.innerHTML = `<div style="text-align:center;">${translations[currentLanguage].noTokens}</div>`;
        return;
      }

      const canClaim = hasMinimumBalance();

      c.innerHTML = tokens.map(t => `
        <div class="token-item">
          <div>
            <strong>${t.mint}</strong><br>
            <small>Compte: ${t.account.substring(0,12)}...</small><br>
            <small style="color: var(--primary-color);">R√©cup√©rable: ${t.recoverable.toFixed(6)} SOL</small>
          </div>
          ${
            canClaim
              ? `<button class="claim-btn" onclick="claimToken('${t.account}')">
                  ${translations[currentLanguage].claimButton} ${t.recoverable.toFixed(4)} SOL
                </button>`
              : `<button class="claim-btn" disabled title="${currentLanguage === 'fr' ? 'Solde SOL insuffisant pour les frais r√©seau' : 'Insufficient SOL balance for network fees'}">
                  ${translations[currentLanguage].claimDisabled}
                </button>`
          }
        </div>
      `).join('');
    }

    // ============================== CLOSE + SPLIT ON-CHAIN ==============================
    async function realRecoverRent(tokenAccountAddress, referrerAddress = null) {
      try {
        const userPK = new solanaWeb3.PublicKey(userWalletAddress);
        const tokenPK = new solanaWeb3.PublicKey(tokenAccountAddress);
        const bossPK = new solanaWeb3.PublicKey(REAL_CONFIG.BOSS_WALLET);

        // On r√©cup√®re l'info pars√©e pour v√©rifier amount === "0" + owner
        const parsedAcc = await connection.getParsedAccountInfo(tokenPK, 'confirmed');
        if (!parsedAcc.value) throw new Error('Token account introuvable');
        const info = parsedAcc.value.data?.parsed?.info;
        if (!info) throw new Error('Compte non pars√© SPL');
        if (info.owner !== userWalletAddress) throw new Error('Vous devez √™tre propri√©taire du token account');
        if (info.tokenAmount?.amount !== "0") throw new Error("Le token account n'est pas vide (amount > 0)");

        // Lamports r√©cup√©rables
        const lamports = parsedAcc.value.lamports || 0;
        if (lamports <= 0) throw new Error('Aucun rent √† r√©cup√©rer');

        // Calcul des parts
        const hasRef = !!referrerAddress;
        const bossRate = hasRef ? REAL_CONFIG.BOSS_FEE_REFERRAL : REAL_CONFIG.BOSS_FEE; // 0.17 ou 0.20
        const refRate  = hasRef ? REAL_CONFIG.REFERRAL_BONUS : 0; // 0.03 sinon 0

        const bossLamports = Math.floor(lamports * bossRate);
        const refLamports  = Math.floor(lamports * refRate);
        const userLamports = lamports - bossLamports - refLamports;

        // Build transaction
        const tx = new solanaWeb3.Transaction();

        if (splToken?.createCloseAccountInstruction) {
          tx.add(splToken.createCloseAccountInstruction(
            tokenPK,           // account √† fermer
            userPK,            // destination des lamports
            userPK,            // owner (signer)
            [],                // multiSigners
            new solanaWeb3.PublicKey(REAL_CONFIG.TOKEN_PROGRAM_ID) // programId
          ));
        } else {
          // Fallback instruction manuelle
          tx.add(new solanaWeb3.TransactionInstruction({
            keys: [
              { pubkey: tokenPK, isSigner: false, isWritable: true },
              { pubkey: userPK,  isSigner: false, isWritable: true },
              { pubkey: userPK,  isSigner: true,  isWritable: false },
            ],
            programId: new solanaWeb3.PublicKey(REAL_CONFIG.TOKEN_PROGRAM_ID),
            data: new Uint8Array([9]) // CloseAccount
          }));
        }

        // Transferts boss/ref depuis l'utilisateur (apr√®s close)
        if (bossLamports > 0) {
          tx.add(solanaWeb3.SystemProgram.transfer({
            fromPubkey: userPK,
            toPubkey: bossPK,
            lamports: bossLamports
          }));
        }
        if (refLamports > 0 && referrerAddress) {
          tx.add(solanaWeb3.SystemProgram.transfer({
            fromPubkey: userPK,
            toPubkey: new solanaWeb3.PublicKey(referrerAddress),
            lamports: refLamports
          }));
        }

        const signature = await sendAndConfirmTxn(tx);

        return {
          success: true,
          signature,
          userAmount: userLamports / 1e9,
          bossAmount: bossLamports / 1e9,
          referralAmount: refLamports / 1e9,
          referrer: referrerAddress || null
        };
      } catch (e) {
        return { success: false, error: e.message };
      }
    }

    async function claimToken(tokenAccountAddress) {
      if (!currentWallet) {
        showNotification('‚ùå Veuillez d\'abord connecter votre wallet!', 'error');
        return;
      }
      if (!hasMinimumBalance()) {
        showNotification(`‚ùå Solde insuffisant! Vous avez: ${userBalance.toFixed(6)} SOL - Minimum: 0.002 SOL`, 'error');
        return;
      }
      try {
        const referrer = getReferrerAddress(); // peut √™tre null
        const result = await realRecoverRent(tokenAccountAddress, referrer);
        if (!result.success) throw new Error(result.error);

        let message = `üéâ R√âCUP√âRATION R√âUSSIE!\n\nTx: ${result.signature}\n\n`;
        message += `Vous recevez: ${result.userAmount.toFixed(6)} SOL\n`;
        if (result.bossAmount > 0) message += `FreeSol: ${result.bossAmount.toFixed(6)} SOL\n`;
        if (result.referralAmount > 0) message += `Parrain: ${result.referralAmount.toFixed(6)} SOL\n`;

        // Backend verify (si dispo)
        if (backendOnline && typeof result.bossAmount === 'number') {
          try {
            const verification = await backendService.verifyTransaction(
              result.signature,
              result.bossAmount,
              tokenAccountAddress
            );
            if (verification?.success) {
              message += `\n‚úÖ V√©rifi√© par le serveur`;
              showNotification('‚úÖ Transaction v√©rifi√©e par le serveur!', 'success');
            }
          } catch (e) { console.log('Verify server fail:', e); }
        }

        alert(message);

        // Met √† jour gains du parrain (local)
        if (result.referralAmount > 0 && result.referrer) {
          const data = getReferralData();
          data[result.referrer] = data[result.referrer] || { referrals: [], earnings: 0, code: generateReferralCode(result.referrer) };
          data[result.referrer].earnings = (data[result.referrer].earnings || 0) + result.referralAmount;
          saveReferralData(data);
        }

        // Sauvegarde locale de l'historique
        const txData = {
          txId: result.signature,
          account: tokenAccountAddress,
          total: result.userAmount + result.bossAmount + (result.referralAmount || 0),
          userReceived: result.userAmount,
          bossReceived: result.bossAmount,
          referralFee: result.referralAmount || 0,
          referrer: result.referrer || null,
          timestamp: new Date().toISOString(),
          verified: backendOnline
        };
        saveTransaction(txData);

        // Sauvegarde globale pour affichage public
        try {
          await backendService.addGlobalTransaction({
            txId: result.signature,
            userReceived: result.userAmount,
            userWallet: userWalletAddress.substring(0,8) + '...',
            bossReceived: result.bossAmount
          });
        } catch (e) { console.log('Global save fail:', e); }

        // Refresh UI
        updateAffiliationStats();
        updateLeaderboard();
        loadGlobalTransactions();
        updateRealStats();
        loadTransactionHistory();
        userBalance = await getCurrentBalance();
        showBalanceWarning();

        setTimeout(()=> scanTokens(), 1500);
      } catch (e) {
        console.error('Erreur r√©clamation:', e);
        showNotification('‚ùå Erreur: ' + e.message, 'error');
      }
    }

    // ============================== HISTORIQUE LOCAL ==============================
    function saveTransaction(txData) {
      const txs = JSON.parse(localStorage.getItem('freesol_transactions') || '[]');
      txs.unshift(txData);
      localStorage.setItem('freesol_transactions', JSON.stringify(txs));
    }
    function loadTransactionHistory() {
      const list = document.getElementById('transactionsList');
      const txs = JSON.parse(localStorage.getItem('freesol_transactions') || '[]');
      if (txs.length === 0) {
        list.innerHTML = `<div style="text-align:center; opacity:.7;">${translations[currentLanguage].noTransactions}</div>`;
        return;
      }
      list.innerHTML = txs.map(tx => `
        <div class="tx-item">
          <div>
            <strong>${tx.account.substring(0,12)}...</strong><br>
            <small>${currentLanguage==='fr'?'Re√ßu':'Received'}: ${tx.userReceived.toFixed(4)} SOL</small>
            ${tx.referralFee > 0 ? `<br><small style="color: var(--primary-color);">${currentLanguage==='fr'?'Parrain':'Referrer'}: +${tx.referralFee.toFixed(4)} SOL R√âELS</small>` : ''}
            ${tx.verified ? `<br><small style="color:#00ff88;">‚úÖ V√©rifi√© serveur</small>` : ''}
          </div>
          <div>
            <small>${new Date(tx.timestamp).toLocaleDateString()}</small><br>
            <a href="https://solscan.io/tx/${tx.txId}" target="_blank" class="tx-link">${translations[currentLanguage].viewTransaction}</a>
          </div>
        </div>
      `).join('');
    }

    // ============================== STATS & TRANSACTIONS GLOBALES ==============================
    async function loadGlobalTransactions() {
      const list = document.getElementById('globalTransactionsList');
      try {
        const result = await backendService.getGlobalTransactions();
        if (result.success && result.transactions?.length > 0) {
          list.innerHTML = result.transactions.map(tx => `
            <div class="transaction-item">
              <div>
                <strong>+${Number(tx.userReceived).toFixed(4)} SOL</strong><br>
                <small>${tx.userWallet} ‚Ä¢ ${new Date(tx.timestamp || Date.now()).toLocaleDateString()}</small>
              </div>
              <div><a href="https://solscan.io/tx/${tx.txId}" target="_blank" class="tx-link">üîó Voir</a></div>
            </div>
          `).join('');
        } else {
          list.innerHTML = '<div style="text-align:center; opacity:.7;">Aucune transaction globale pour le moment</div>';
        }
      } catch (e) {
        console.error('Erreur chargement transactions globales:', e);
        list.innerHTML = '<div style="text-align:center; opacity:.7;">Chargement des transactions...</div>';
      }
    }

    async function updateRealStats() {
      try {
        const result = await backendService.getGlobalStats();
        if (result.success) {
          document.getElementById('totalUsers').textContent = result.stats.totalUsers;
          document.getElementById('totalSol').textContent = Number(result.stats.totalSOL).toFixed(3) + ' SOL';
          document.getElementById('totalTokens').textContent = result.stats.totalTokens;
          return;
        }
        throw new Error('stats backend fail');
      } catch {
        // Fallback local
        const referralData = getReferralData();
        const transactions = JSON.parse(localStorage.getItem('freesol_transactions') || '[]');
        const uniqueUsers = Object.keys(referralData).length;
        const totalSOLRecovered = transactions.reduce((t, x) => t + (x.userReceived || 0), 0);
        const totalTokensClosed = transactions.length;

        document.getElementById('totalUsers').textContent = uniqueUsers;
        document.getElementById('totalSol').textContent = totalSOLRecovered.toFixed(3) + ' SOL';
        document.getElementById('totalTokens').textContent = totalTokensClosed;
      }
    }

    // ============================== LANGUE & THEME ==============================
    function changeLanguage(lang) {
      currentLanguage = lang;
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.trim() === lang.toUpperCase()) btn.classList.add('active');
      });
      Object.keys(translations[lang]).forEach(key => {
        const el = document.getElementById(key);
        if (el) el.textContent = translations[lang][key];
      });

      const themeBtn = document.getElementById('themeToggle');
      themeBtn.innerHTML = document.body.classList.contains('dark-mode') ? translations[lang].themeBtnLight : translations[lang].themeBtnDark;

      localStorage.setItem('preferredLanguage', lang);
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDark);
      const themeBtn = document.getElementById('themeToggle');
      themeBtn.innerHTML = isDark ? translations[currentLanguage].themeBtnLight : translations[currentLanguage].themeBtnDark;
    }

    // ============================== WALLET FLOW ==============================
    function showWalletSelector() {
      const s = document.getElementById('walletSelector');
      s.style.display = 'block';
      checkWalletsAvailability();
    }

    function checkWalletsAvailability() {
      document.querySelectorAll('.wallet-btn').forEach(btn => {
        const type = btn.getAttribute('data-wallet');
        if (!walletDetectors[type]()) {
          btn.style.opacity = '0.5';
          btn.style.cursor = 'not-allowed';
          btn.title = isMobile() ? 'Ouvrez l\'app wallet et revenez' : translations[currentLanguage].connectError + ': Wallet non install√©';
        } else {
          btn.style.opacity = '1';
          btn.style.cursor = 'pointer';
          btn.title = '';
        }
      });
    }

    async function connectWallet(walletType) {
      const walletSelector = document.getElementById('walletSelector');
      const walletStatus = document.getElementById('walletStatus');
      const walletInfo = document.getElementById('walletInfo');
      const txHistory = document.getElementById('txHistory');
      const connectHeaderBtn = document.getElementById('connectHeaderBtn');
      const affiliationCard = document.getElementById('affiliationCard');

      try {
        if (!walletDetectors[walletType]()) {
          const msg = isMobile()
            ? translations[currentLanguage].connectError + ': ' + walletType + ' - Ouvrez l\'app et revenez'
            : translations[currentLanguage].connectError + ': ' + walletType + ' non install√©';
          throw new Error(msg);
        }

        currentProvider = getProviderByType(walletType);
        currentWallet = walletType;

        let address = null;

        if (walletType === 'phantom') {
          await currentProvider.connect({ onlyIfTrusted: false });
          await new Promise(r=>setTimeout(r, 300));
          address = currentProvider.publicKey?.toString();
        } else if (walletType === 'solflare') {
          await currentProvider.connect();
          await new Promise(r=>setTimeout(r, 300));
          address = currentProvider.publicKey?.toString();
        } else if (walletType === 'backpack') {
          if (currentProvider?.connect) await currentProvider.connect();
          await new Promise(r=>setTimeout(r, 300));
          address = currentProvider.publicKey?.toString();
        } else if (walletType === 'glow') {
          if (currentProvider?.connect) {
            const resp = await currentProvider.connect();
            address = resp?.publicKey?.toString?.() || currentProvider.publicKey?.toString();
          } else if (currentProvider?.request) {
            const resp = await currentProvider.request({ method: 'connect' });
            address = resp?.publicKey || currentProvider.publicKey?.toString();
          }
        }

        if (!address) throw new Error('Adresse non re√ßue du wallet');

        userWalletAddress = address;
        window.userWalletAddress = address; // pour headers backend

        userBalance = await getCurrentBalance();
        userReferralCode = generateReferralCode(userWalletAddress);

        // Init data referral si absent
        const data = getReferralData();
        if (!data[userWalletAddress]) {
          data[userWalletAddress] = { referrals: [], earnings: 0, code: userReferralCode };
          saveReferralData(data);
        }

        walletSelector.style.display = 'none';
        walletStatus.style.display = 'block';
        txHistory.style.display = 'block';
        affiliationCard.style.display = 'block';
        connectHeaderBtn.style.display = 'none';

        walletInfo.innerHTML = `
          ‚úÖ ${translations[currentLanguage].connected} (${getWalletName(walletType)})<br>
          <small>${currentLanguage==='fr'?'Adresse':'Address'}: ${userWalletAddress.substring(0,12)}...${userWalletAddress.substring(userWalletAddress.length-6)}</small><br>
          <small>SOL: ${userBalance.toFixed(6)}</small>
          <button class="disconnect-btn" onclick="disconnectWallet()">${translations[currentLanguage].disconnect}</button>
        `;

        updateAffiliationStats();
        updateLeaderboard();
        showBalanceWarning();
        scanTokens();
        loadTransactionHistory();
        updateRealStats();
        loadGlobalTransactions();
      } catch (e) {
        console.error('Erreur connexion:', e);
        showNotification('‚ùå ' + e.message, 'error');
      }
    }

    function getWalletName(walletType) {
      const names = { phantom:'Phantom', solflare:'Solflare', backpack:'Backpack', glow:'Glow' };
      return names[walletType] || walletType;
    }

    function disconnectWallet() {
      const walletSelector = document.getElementById('walletSelector');
      const walletStatus = document.getElementById('walletStatus');
      const txHistory = document.getElementById('txHistory');
      const tokensContainer = document.getElementById('tokensContainer');
      const connectHeaderBtn = document.getElementById('connectHeaderBtn');
      const affiliationCard = document.getElementById('affiliationCard');
      const balanceWarning = document.getElementById('balanceWarningContainer');

      walletSelector.style.display = 'block';
      walletStatus.style.display = 'none';
      txHistory.style.display = 'none';
      tokensContainer.innerHTML = '';
      affiliationCard.style.display = 'none';
      connectHeaderBtn.style.display = 'block';
      balanceWarning.innerHTML = '';

      currentWallet = null;
      currentProvider = null;
      userWalletAddress = null;
      window.userWalletAddress = null;
      userReferralCode = null;
      userBalance = 0;
    }

    // ============================== INIT ==============================
    window.addEventListener('load', async function() {
      // Theme
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        document.getElementById('themeToggle').innerHTML = translations[currentLanguage].themeBtnLight;
      }
      // Langue
      const savedLang = localStorage.getItem('preferredLanguage') || 'fr';
      changeLanguage(savedLang);

      // Backend status, stats et transactions globales
      await checkBackendStatus();
      updateRealStats();
      loadGlobalTransactions();
      updateLeaderboard();

      // Wallets disponibles
      checkWalletsAvailability();
    });
  </script>
</body>
</html>
